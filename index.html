<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Rio Links Golf Course</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Rio Links">
  <!-- Chart.js for handicap history graph -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      font-size: 16px;
    }
    body {
      margin: 0;
      background: #f5f5f7;
    }
    .app {
      max-width: 480px;
      margin: 0 auto;
      min-height: 100vh;
      background: #fff;
      display: flex;
      flex-direction: column;
    }
    header {
      padding: 12px 16px;
      border-bottom: 1px solid #ddd;
      text-align: center;
    }
    header h1 {
      font-size: 1.1rem;
      margin: 0;
      font-weight: 600;
    }
    header .subtitle {
      font-size: 0.8rem;
      color: #666;
      margin-top: 2px;
    }
    main {
      padding: 14px;
      flex: 1;
    }
    footer {
      padding: 8px;
      text-align: center;
      font-size: 0.75rem;
      color: #888;
      border-top: 1px solid #eee;
    }

    .hidden { display: none; }

    .btn {
      display: block;
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: none;
      font-size: 1rem;
      font-weight: 500;
      margin: 6px 0;
      background: #007aff;
      color: #fff;
    }
    .btn-secondary {
      background: #e5e5ea;
      color: #111;
    }
    .btn-small {
      display: inline-block;
      width: auto;
      padding: 8px 12px;
      font-size: 0.85rem;
      border-radius: 8px;
      border: none;
      margin: 4px 4px 0 0;
    }

    .section-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 8px;
    }
    ul {
      list-style: none;
      margin: 0;
      padding: 0;
    }
    li {
      padding: 6px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    input[type="text"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 0.95rem;
      margin-bottom: 8px;
    }

    .pill {
      display: inline-block;
      padding: 3px 6px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #f2f2f7;
      margin-left: 6px;
    }

    .player-row {
      margin-top: 10px;
      padding: 10px;
      border-radius: 10px;
      background: #f8f8fa;
    }

    .score-buttons button {
      margin: 5px;
      padding: 16px 20px;
      font-size: 1.2rem;
      border-radius: 12px;
      border: none;
      background: #e5e5ea;
    }
    .score-buttons button.selected {
      background: #34c759;
      color: #fff;
      transform: scale(1.15);
    }

    #roundHoleLabel {
      font-weight: 700;
      color: #007aff;
      font-size: 1.2rem;
      text-shadow: 0 0 6px rgba(0,122,255,0.2);
      margin-bottom: 4px;
    }

    .hole-label {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .banner {
      background: #f2f2f7;
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 0.85rem;
      margin-bottom: 10px;
    }

    .fade-in {
      animation: fade 0.25s ease-out;
    }
    @keyframes fade {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .history-card {
      margin-bottom: 12px;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ddd;
      font-size: 0.9rem;
    }
    .history-card strong {
      font-size: 0.85rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }
    th, td {
      padding: 4px;
      text-align: right;
    }
    th:first-child, td:first-child {
      text-align: left;
    }
    tr:nth-child(even) {
      background: #fafafa;
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>⛳ Rio Links</h1>
    <div class="subtitle">Barred Owl · Great Horned Owl</div>
  </header>

  <main>
    <!-- HOME -->
    <section id="screen-home">
      <div class="section-title">Home</div>
      <button class="btn" id="btnHomeStart">Start Round</button>
      <button class="btn btn-secondary" id="btnHomePlayers">Players</button>
      <button class="btn btn-secondary" id="btnHomeHistory">History</button>
      <button class="btn btn-secondary" id="btnHomeAnalytics">Analytics</button>
      <button class="btn btn-secondary" id="btnHomeLeaderboard">Leaderboards</button>
      <button class="btn btn-secondary" id="btnHomeExport">Export CSV</button>
    </section>

    <!-- PLAYERS -->
    <section id="screen-players" class="hidden">
      <div class="section-title">Players</div>
      <input id="playerNameInput" type="text" placeholder="Add player (Luke, Mike, Gina...)">
      <button class="btn" id="btnAddPlayer">Add Player</button>
      <ul id="playersList"></ul>
      <button class="btn-small btn-secondary" id="btnBackFromPlayers">&lt; Home</button>
    </section>

    <!-- SELECT PLAYERS -->
    <section id="screen-select-players" class="hidden">
      <div class="section-title">Select Players</div>
      <ul id="playerSelectList"></ul>
      <button class="btn" id="btnStartRoundFromSelection">Begin Round</button>
      <button class="btn-small btn-secondary" id="btnBackFromSelect">&lt; Home</button>
    </section>

    <!-- ROUND -->
    <section id="screen-round" class="hidden">
      <div id="roundHoleLabel"></div>
      <div class="hole-label" id="holeTitle"></div>
      <div class="banner" id="roundScoreBanner"></div>

      <div id="scoreButtonsContainer"></div>

      <div style="margin-top:10px;">
        <button class="btn-small btn-secondary" id="btnPrevHole">&lt; Prev</button>
        <button class="btn-small btn-secondary" id="btnNextHole">Next &gt;</button>
      </div>

      <button class="btn" id="btnFinishRoundBottom" disabled style="margin-top:20px;opacity:0.4;">
        Save Round
      </button>
      <button class="btn-small btn-secondary" id="btnBackFromRound">&lt; Cancel Round</button>
    </section>

    <!-- SUMMARY -->
    <section id="screen-summary" class="hidden">
      <div class="section-title">Round Summary</div>
      <div id="summaryContent"></div>
      <button class="btn" id="btnSummaryDone">Back to Home</button>
    </section>

    <!-- HISTORY -->
    <section id="screen-history" class="hidden">
      <div class="section-title">Recent Rounds</div>
      <div id="historyContent"></div>
      <button class="btn-small btn-secondary" id="btnBackFromHistory">&lt; Home</button>
    </section>

    <!-- ANALYTICS -->
    <section id="screen-analytics" class="hidden">
      <div class="section-title">Analytics</div>
      <ul id="analyticsPlayerList"></ul>
      <div id="analyticsResults" style="margin-top:10px;"></div>
      <canvas id="handicapChart" width="400" height="220" style="margin-top:20px;"></canvas>
      <button class="btn-small btn-secondary" id="btnBackFromAnalytics">&lt; Home</button>
    </section>

    <!-- LEADERBOARDS -->
    <section id="screen-leaderboards" class="hidden">
      <div class="section-title">All-Time Leaderboards</div>
      <div id="leaderboardOverall" style="margin-top:10px;"></div>
      <div id="leaderboardBarred" style="margin-top:18px;"></div>
      <div id="leaderboardHorned" style="margin-top:18px;"></div>
      <button class="btn-small btn-secondary" id="btnBackFromLeaderboards">&lt; Home</button>
    </section>
  </main>

  <footer>
    Rio Links • Family Putting History
  </footer>
</div>

<script type="module">
  // ---- Firebase imports ----
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  // ---- Firebase config (yours) ----
  const firebaseConfig = {
    apiKey: "AIzaSyCX9C7uy5JNklprp3tZeKV3tPGr410ix28",
    authDomain: "rio-links.firebaseapp.com",
    projectId: "rio-links",
    storageBucket: "rio-links.firebasestorage.app",
    messagingSenderId: "260295353704",
    appId: "1:260295353704:web:8700c3a72ccf786d1762dd",
    measurementId: "G-6MVV3ZFT3T"
  };

  const firebaseApp = initializeApp(firebaseConfig);
  const db = getFirestore(firebaseApp);
  const FAMILY_DOC_REF = doc(db, "rioLinks", "rio-links-family-1");

  // ---- Core constants ----
  const STORAGE_KEY = "rio-links_v2";
  const PAR = 2;
  const HOLES = 20;
  const COURSE_PAR = PAR * HOLES;

  const HOLE_NAMES = [
    "First Flight", "Arrow Line", "Hunter’s Hook", "Rising Edge", "Gravity Glide",
    "Climbing Turn", "The Drop Point", "Gauntlet Ridge", "Perch Line", "Switchback",
    "Moon Curve", "The Ascent", "Silent Path", "Hollow Ridge", "The Horseshoe",
    "Reverse Shoe", "Second Ridge", "True North", "Slope Run", "Home Roost"
  ];

  // ---- Sounds ----
  const sounds = {
    click: new Audio("https://assets.mixkit.co/sfx/preview/mixkit-soft-button-click-1126.mp3"),
    nextHole: new Audio("https://assets.mixkit.co/sfx/preview/mixkit-nav-tap-2920.mp3"),
    ace: new Audio("https://assets.mixkit.co/sfx/preview/mixkit-cartoon-bird-cry-33.mp3"),
    birdie: new Audio("https://assets.mixkit.co/sfx/preview/mixkit-small-bird-chirp-33.mp3")
  };

  // ---- State ----
  let appData = { players: [], rounds: [] }; // rounds: {id,date,scores{pid:[20]}}
  let currentRound = null;
  let editModeRoundId = null;
  let handicapChartInstance = null;

  // ---- Storage helpers ----
  function loadLocal() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) {
      try { appData = JSON.parse(raw); } catch(e) { console.error(e); }
    }
    i
