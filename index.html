<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Rio Links Golf Course</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Rio Links">

<style>
  :root {
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    font-size: 16px;
    color-scheme: light;
  }
  body { margin: 0; background: #f5f5f7; }
  .app { max-width: 480px; margin: auto; min-height: 100vh; background: white; display: flex; flex-direction: column; }
  header { padding: 12px; text-align: center; border-bottom: 1px solid #ddd; }
  header h1 { margin: 0; font-size: 1.1rem; }
  .btn { width: 100%; padding: 12px; margin: 6px 0; border-radius: 10px; border: none; background: #007aff; color: white; font-size: 1rem; }
  .btn-secondary { background: #e5e5ea; color: #111; }
  .btn-small { padding: 6px 10px; }
  .hidden { display:none; }
  .section-title { font-weight: 600; margin-bottom: 8px;}
  ul { list-style: none; padding: 0; }
  li { padding: 6px 0; border-bottom: 1px solid #eee;}
  .player-row { background:#f8f8f8; padding:10px; border-radius:10px; margin-top:10px;}
  .hole-label { font-size:1rem; font-weight:600; margin-bottom:4px;}
  .pill { padding: 3px 6px; background:#f1f1f1; border-radius:8px; font-size:.75rem; }
  .score-buttons button.selected { background:#34c759; color:white;}
</style>
</head>

<body>
<div class="app">
<header>
  <h1>‚õ≥ Rio Links Golf Course</h1>
  <div style="font-size:.8rem;color:#666;">Barred Owl & Great Horned Owl</div>
</header>

<main>

<!-- HOME -->
<section id="screen-home">
  <button class="btn" id="btnHomeStart">Start Round</button>
  <button class="btn btn-secondary" id="btnHomePlayers">Players</button>
  <button class="btn btn-secondary" id="btnHomeHistory">History</button>
  <button class="btn btn-secondary" id="btnHomeAnalytics">Analytics</button>
  <button class="btn btn-secondary" id="btnHomeExport">Export CSV</button>
</section>

<!-- PLAYERS -->
<section id="screen-players" class="hidden">
  <div class="section-title">Players</div>
  <input id="playerNameInput" placeholder="Add Player" style="width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;">
  <button class="btn" id="btnAddPlayer">Add</button>
  <ul id="playersList"></ul>
  <button class="btn-small btn-secondary" id="btnBackFromPlayers">&lt; Back</button>
</section>

<!-- SELECT PLAYERS -->
<section id="screen-select-players" class="hidden">
  <div class="section-title">Select Players</div>
  <ul id="playerSelectList"></ul>
  <button class="btn" id="btnStartRoundFromSelection">Begin Round</button>
  <button class="btn-small btn-secondary" id="btnBackFromSelect">&lt; Back</button>
</section>

<!-- ROUND -->
<section id="screen-round" class="hidden">
  <div id="roundHoleLabel" class="section-title"></div>
  <div id="holeTitle" style="margin-bottom:12px;"></div>
  <div id="roundScoreBanner" style="background:#eee;padding:10px;border-radius:8px;"></div>
  <div id="scoreButtonsContainer"></div>

  <button class="btn-small btn-secondary" id="btnPrevHole">Prev</button>
  <button class="btn-small btn-secondary" id="btnNextHole">Next</button>
  <button class="btn" id="btnFinishRoundTop">Save Round</button>
  <button class="btn-small btn-secondary" id="btnBackFromRound">&lt; Cancel</button>
</section>

<!-- SUMMARY -->
<section id="screen-summary" class="hidden">
  <div class="section-title">Round Summary</div>
  <div id="summaryContent"></div>
  <button class="btn" id="btnSummaryDone">Home</button>
</section>

<!-- HISTORY -->
<section id="screen-history" class="hidden">
  <div class="section-title">History</div>
  <div id="historyContent"></div>
  <button class="btn-small btn-secondary" id="btnBackFromHistory">&lt; Back</button>
</section>

<!-- ANALYTICS -->
<section id="screen-analytics" class="hidden">
  <div class="section-title">Analytics</div>
  <ul id="analyticsPlayerList"></ul>
  <div id="analyticsResults"></div>
  <div id="leaderboardContent" style="margin-top:20px;"></div>
  <button class="btn-small btn-secondary" id="btnBackFromAnalytics">&lt; Back</button>
</section>

</main>
<footer style="text-align:center;font-size:.75rem;padding:10px;color:#888;">Rio Links ‚Ä¢ Est. 2025</footer>
</div>

<script type="module">

/* ----------------------- FIREBASE ----------------------- */

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

/* ---- YOUR FIREBASE CONFIG (UPDATED) ---- */

const firebaseConfig = {
  apiKey: "AIzaSyCX9C7uy5JNklprp3tZeKV3tPGr410ix28",
  authDomain: "rio-links.firebaseapp.com",
  projectId: "rio-links",
  storageBucket: "rio-links.firebasestorage.app",
  messagingSenderId: "260295353704",
  appId: "1:260295353704:web:8700c3a72ccf786d1762dd",
  measurementId: "G-6MVV3ZFT3T"
};

const firebaseApp = initializeApp(firebaseConfig);
const db = getFirestore(firebaseApp);
const FAMILY_DOC_REF = doc(db, "rioLinks", "rio-links-family-1");


/* ----------------------- DATA + SETTINGS ----------------------- */

const STORAGE_KEY = 'rio-links_v2';
const PAR = 2;
const HOLES = 20;
const COURSE_PAR = PAR * HOLES;

const HOLE_NAMES = [
  "First Flight", "Arrow Line", "Hunter‚Äôs Hook", "Rising Edge", "Gravity Glide",
  "Climbing Turn", "The Drop Point", "Gauntlet Ridge", "Perch Line", "Switchback",
  "Moon Curve", "The Ascent", "Silent Path", "Hollow Ridge", "The Horseshoe",
  "Reverse Shoe", "Second Ridge", "True North", "Slope Run", "Home Roost"
];

let appData = { players: [], rounds: [] };
let currentRound = null;
let editModeRoundId = null;

/* ----------------------- LOCAL STORAGE ----------------------- */

function loadLocal() {
  const saved = localStorage.getItem(STORAGE_KEY);
  if (saved) appData = JSON.parse(saved);
}

function saveLocal() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
}

/* ----------------------- FIREBASE SYNC ----------------------- */

async function loadFromFirebase() {
  try {
    const snap = await getDoc(FAMILY_DOC_REF);
    if (snap.exists()) {
      appData = snap.data();
      saveLocal();
      console.log("Loaded from Firebase");
    } else {
      await saveToFirebase();
      console.log("Created new Firebase record");
    }
  } catch(err) {
    console.warn("Firebase load failed:", err);
  }
}

async function saveToFirebase() {
  try {
    await setDoc(FAMILY_DOC_REF, appData);
  } catch(err) {
    console.warn("Firebase save failed:", err);
  }
}

function saveAll() {
  saveLocal();
  saveToFirebase();
}

/* ----------------------- UTILITIES ----------------------- */

const fmt = n => n > 0 ? `+${n}` : n === 0 ? "E" : n;

function getPlayer(id) {
  return appData.players.find(p => p.id === id);
}

function getPlayerRounds(id) {
  return appData.rounds.filter(r => r.scores[id])
    .sort((a,b)=>new Date(a.date)-new Date(b.date));
}

function computeHandicap(id) {
  const rounds = getPlayerRounds(id).slice(-10);
  if (!rounds.length) return 0;

  const diffs = rounds.map(r => {
    const total = r.scores[id].reduce((a,b)=>a+b,0);
    return total - COURSE_PAR;
  });

  return Math.round((diffs.reduce((a,b)=>a+b,0) / diffs.length) * 10) / 10;
}

/* ----------------------- UI RENDERERS ----------------------- */

function show(screenId) {
  document.querySelectorAll("section").forEach(s => s.classList.add("hidden"));
  document.getElementById(screenId).classList.remove("hidden");
}

function renderPlayers() {
  const ul = document.getElementById("playersList");
  ul.innerHTML = appData.players.map(p => {
    const hc = computeHandicap(p.id);
    return `<li>${p.name} <span class="pill">hcp ${hc>0?`+${hc}`:hc}</span></li>`;
  }).join("") || "<li>No players yet</li>";
}

function renderPlayerSelection() {
  const ul = document.getElementById("playerSelectList");
  ul.innerHTML = appData.players.map(p => `
    <li>
      <label style="display:flex;justify-content:space-between;">
        ${p.name}
        <input type="checkbox" value="${p.id}">
      </label>
    </li>
  `).join("") || "<li>No players</li>";
}

function startRound(selected) {
  currentRound = {
    id: "r_" + Date.now(),
    date: new Date().toISOString(),
    playerIds: selected,
    currentHole: 1,
    scores: Object.fromEntries(selected.map(id => [id, Array(HOLES).fill(null)]))
  };
  editModeRoundId = null;
  renderRound();
  show("screen-round");
}

function renderRound() {
  const h = currentRound.currentHole;
  document.getElementById("roundHoleLabel").textContent = `Hole ${h}/${HOLES}`;

  document.getElementById("holeTitle").textContent =
    `${h <= 10 ? "Barred Owl" : "Great Horned Owl"} ¬∑ ${HOLE_NAMES[h-1]} (Par ${PAR})`;

  let banner = "";
  currentRound.playerIds.forEach(pid => {
    const scores = currentRound.scores[pid];
    const played = scores.filter(n=>n!==null);
    const total = played.reduce((a,b)=>a+b,0);
    banner += `<div>${getPlayer(pid).name}: ${total} (${fmt(total-(played.length*PAR))})</div>`;
  });

  document.getElementById("roundScoreBanner").innerHTML = banner;
  const buttonsDiv = document.getElementById("scoreButtonsContainer");
  buttonsDiv.innerHTML = "";

  currentRound.playerIds.forEach(pid => {
    const row = document.createElement("div");
    row.className = "player-row";
    row.innerHTML = `<strong>${getPlayer(pid).name}</strong>`;

    [1,2,3,4,5].forEach(num => {
      const btn = document.createElement("button");
      btn.className = "btn-small btn-secondary";
      btn.textContent=num;

      if (currentRound.scores[pid][h-1]===num) btn.classList.add("selected");

      btn.onclick=()=>{
        currentRound.scores[pid][h-1]=num;
        renderRound();
      }
      row.appendChild(btn);
    });

    buttonsDiv.appendChild(row);
  });
}

/* ----------------------- FINISH ROUND ----------------------- */

function finalizeRound() {
  if (editModeRoundId) {
    const idx = appData.rounds.findIndex(r=>r.id===editModeRoundId);
    if (idx>=0) appData.rounds[idx] = currentRound;
  } else {
    appData.rounds.push(currentRound);
  }

  saveAll();
  renderSummary(currentRound);
  currentRound=null;
  editModeRoundId=null;
  show("screen-summary");
}

function renderSummary(round) {
  const div = document.getElementById("summaryContent");
  let html = `<div><strong>${new Date(round.date).toLocaleString()}</strong></div>`;

  let bestScore=null, winners=[];

  round.playerIds.forEach(pid=>{
    const total = round.scores[pid].reduce((a,b)=>a+b,0);
    const diff = total-COURSE_PAR;
    if (bestScore===null || diff<bestScore) {
      bestScore=diff;
      winners=[getPlayer(pid).name];
    } else if (diff===bestScore) winners.push(getPlayer(pid).name);

    html+=`<div style="margin:6px 0;">
      ${getPlayer(pid).name}: <strong>${total} (${fmt(diff)})</strong>
    </div>`;
  });

  html+=`<div style="margin-top:10px;">üèÜ Winner: ${winners.join(", ")}</div>`;
  div.innerHTML=html;
}

/* ----------------------- HISTORY ----------------------- */

function renderHistory() {
  const div=document.getElementById("historyContent");
  div.innerHTML=appData.rounds.slice().reverse().map(r=>{
    const date=new Date(r.date).toLocaleString();
    let players='';
    Object.keys(r.scores).forEach(pid=>{
      const total=r.scores[pid].reduce((a,b)=>a+b,0);
      const diff=total-COURSE_PAR;
      players+=`${getPlayer(pid).name}: ${total} (${fmt(diff)})<br>`;
    });

    return `
      <div style="margin-bottom:12px;padding:10px;border:1px solid #ddd;border-radius:8px;">
        <strong>${date}</strong><br>${players}
        <button class="btn-small" onclick="editRound('${r.id}')">Edit</button>
        <button class="btn-small btn-secondary" onclick="deleteRound('${r.id}')">Delete</button>
      </div>`;
  }).join("") || "<p>No rounds yet</p>";
}

window.deleteRound=id=>{
  if(!confirm("Delete round?"))return;
  appData.rounds=appData.rounds.filter(r=>r.id!==id);
  saveAll();
  renderHistory();
}

window.editRound=id=>{
  const r=appData.rounds.find(x=>x.id===id);
  editModeRoundId=id;
  currentRound=JSON.parse(JSON.stringify(r));
  renderRound();
  show("screen-round");
}

/* ----------------------- ANALYTICS ----------------------- */

function computeAnalytics(pid){
  const rounds=getPlayerRounds(pid);
  if(!rounds.length)return null;
  const totals=rounds.map(r=>r.scores[pid].reduce((a,b)=>a+b,0));
  return {
    avg:Math.round((totals.reduce((a,b)=>a+b,0)/totals.length)*10)/10,
    best:Math.min(...totals),
    worst:Math.max(...totals),
    handicap:computeHandicap(pid)
  }
}

function renderAnalyticsPlayers(){
  const ul=document.getElementById("analyticsPlayerList");
  ul.innerHTML=appData.players.map(p=>`
    <li onclick="showAnalytics('${p.id}')" style="cursor:pointer;">${p.name}</li>
  `).join("") || "<li>No players</li>";
}

window.showAnalytics=pid=>{
  const a=computeAnalytics(pid);
  if(!a){document.getElementById("analyticsResults").innerHTML="No rounds";return;}
  document.getElementById("analyticsResults").innerHTML=`
    <p><strong>Avg Score:</strong> ${a.avg}</p>
    <p><strong>Best:</strong> ${a.best}</p>
    <p><strong>Worst:</strong> ${a.worst}</p>
    <p><strong>Handicap:</strong> ${a.handicap>0?`+${a.handicap}`:a.handicap}</p>
  `;
  renderLeaderboard();
}

function renderLeaderboard(){
  const lb=document.getElementById("leaderboardContent");
  const rows=[];
  appData.rounds.forEach(r=>{
    Object.keys(r.scores).forEach(pid=>{
      rows.push({
        player:getPlayer(pid).name,
        strokes:r.scores[pid].reduce((a,b)=>a+b,0),
        diff:r.scores[pid].reduce((a,b)=>a+b,0)-COURSE_PAR
      });
    });
  });
  const best=rows.slice().sort((a,b)=>a.strokes-b.strokes).slice(0,10);
  lb.innerHTML="<h3>Top 10</h3>"+best.map(r=>`${r.player}: ${r.strokes} (${fmt(r.diff)})`).join("<br>");
}

/* ----------------------- EXPORT ----------------------- */

function exportCSV(){
  if(!appData.rounds.length)return alert("No data!");
  let rows=["Date,Player,Hole,Score"];
  appData.rounds.forEach(r=>{
    Object.keys(r.scores).forEach(pid=>{
      r.scores[pid].forEach((s,i)=>{
        rows.push(`${r.date},${getPlayer(pid).name},${i+1},${s}`);
      });
    });
  });
  const blob=new Blob([rows.join("\n")],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="rio-links.csv";
  a.click();
  URL.revokeObjectURL(url);
}

/* ----------------------- BUTTON WIRING ----------------------- */

document.getElementById("btnHomeStart").onclick=()=>{renderPlayerSelection();show("screen-select-players");};
document.getElementById("btnHomePlayers").onclick=()=>{renderPlayers();show("screen-players");};
document.getElementById("btnHomeHistory").onclick=()=>{renderHistory();show("screen-history");};
document.getElementById("btnHomeAnalytics").onclick=()=>{renderAnalyticsPlayers();show("screen-analytics");};
document.getElementById("btnHomeExport").onclick=exportCSV;

document.getElementById("btnAddPlayer").onclick=()=>{
  const input=document.getElementById("playerNameInput");
  const name=input.value.trim();
  if(name){
    appData.players.push({id:"p_"+Date.now(),name});
    saveAll();
  }
  input.value="";
  renderPlayers();
};

document.getElementById("btnStartRoundFromSelection").onclick=()=>{
  const selected=[...document.querySelectorAll("#playerSelectList input:checked")].map(x=>x.value);
  if(!selected.length)return alert("Pick a player");
  startRound(selected);
};

document.getElementById("btnPrevHole").onclick=()=>{currentRound.currentHole=Math.max(1,currentRound.currentHole-1);renderRound();}
document.getElementById("btnNextHole").onclick=()=>{currentRound.currentHole=Math.min(HOLES,currentRound.currentHole+1);renderRound();}
document.getElementById("btnFinishRoundTop").onclick=finalizeRound;
document.getElementById("btnBackFromRound").onclick=()=>{if(confirm("Cancel round?"))show("screen-home");}
document.getElementById("btnSummaryDone").onclick=()=>show("screen-home");
document.getElementById("btnBackFromPlayers").onclick=()=>show("screen-home");
document.getElementById("btnBackFromSelect").onclick=()=>show("screen-home");
document.getElementById("btnBackFromHistory").onclick=()=>show("screen-home");
document.getElementById("btnBackFromAnalytics").onclick=()=>show("screen-home");

/* ----------------------- APP INIT ----------------------- */

loadLocal();
loadFromFirebase(); // cloud sync
renderPlayers();
show("screen-home");

</script>
</body>
</html>


